{% extends "base.html" %}
{% load static %}
{% block title %}Cargar libro{% endblock %}

{% block content %}
<h1 class="mb-3 text-center">Cargar libro</h1>

{# Mensajes de Django (para POST normales como guardar/eliminar) #}
{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }} mb-2">{{ m }}</div>
  {% endfor %}
{% endif %}

{# Área para mensajes de AJAX (crear categoría) #}
<div id="flash-area" class="mb-2"></div>

<form id="form-libro"
      class="card p-3 bg-white needs-validation"
      method="post"
      action="{% url 'libro_create' %}"
      novalidate>
  {% csrf_token %}

  <div class="row g-3">
    <!-- Título -->
    <div class="col-md-6">
      <label class="form-label">Título</label>
      {{ form.titulo }}
      <div class="invalid-feedback">Ingresá un título (2–200 caracteres).</div>
      {% if form.titulo.errors %}
        <div class="text-danger small mt-1">{{ form.titulo.errors|striptags }}</div>
      {% endif %}
    </div>

    <!-- Autor -->
    <div class="col-md-6">
      <label class="form-label">Autor</label>
      {{ form.autor }}
      <div class="invalid-feedback">Ingresá un autor válido.</div>
      {% if form.autor.errors %}
        <div class="text-danger small mt-1">{{ form.autor.errors|striptags }}</div>
      {% endif %}
    </div>

    <!-- Categorías (Multiple) -->
    <div class="col-md-12">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span>Categorías</span>
        <small class="text-muted">Podés seleccionar varias (Ctrl/Shift).</small>
      </label>
      {{ form.categorias }}
      <div class="invalid-feedback">Seleccioná al menos una categoría (opcional).</div>
      {% if form.categorias.errors %}
        <div class="text-danger small mt-1">{{ form.categorias.errors|striptags }}</div>
      {% endif %}

      <!-- Crear nueva categoría (AJAX) -->
      <div class="mt-3 border rounded p-2">
        <div class="d-flex gap-2 align-items-center">
          <input id="new-cat-name" class="form-control" type="text" placeholder="Nueva categoría (ej.: Psicología Social)">
          <button id="btn-add-cat" type="button" class="btn btn-outline-primary btn-cat">
            + Agregar categoría
          </button>
        </div>
        <div id="new-cat-help" class="form-text">Se agrega y queda seleccionada automáticamente.</div>
        <div id="new-cat-error" class="alert alert-danger py-1 px-2 mt-2 d-none"></div>
      </div>

      <!-- Eliminar categorías -->
      {% if categorias_all %}
      <div class="mt-3">
        <div class="d-flex align-items-center justify-content-between">
          <strong>Eliminar categoría</strong>
          <small class="text-muted">Los títulos de esa categoría pasarán a “Otros”.</small>
        </div>
        <div class="list-group mt-2">
          {% for c in categorias_all %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ c.nombre }}</span>
              <form method="post" action="{% url 'categoria_delete' c.id %}"
                    onsubmit="return confirm('¿Eliminar la categoría «{{ c.nombre }}»? Los títulos quedarán en “Otros”.');">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
              </form>
            </div>
          {% empty %}
            <div class="list-group-item text-muted">No hay categorías todavía.</div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

<div class="mt-3 d-flex gap-2">
  <button id="btn-save" type="button" class="btn btn-primary">Guardar</button>
  <a class="btn btn-outline-secondary" href="{% url 'libros_list' %}">Cancelar</a>
</div>
</form>

<script>
/* Validación visual al tipear (Bootstrap) */
document.addEventListener("input", (e) => {
  const form = e.target.closest("#form-libro");
  if (form) form.classList.add("was-validated");
});

/* CSRF cookie util */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
}
const csrftoken = getCookie('csrftoken');

/* Flash UI para AJAX */
function flash(type, text) {
  const box = document.getElementById('flash-area');
  if (!box) return;
  const div = document.createElement('div');
  div.className = `alert alert-${type} mb-2`;
  div.textContent = text;
  box.appendChild(div);
  setTimeout(() => div.remove(), 3500);
}

/* Alta de categoría por AJAX */
const addBtn = document.getElementById('btn-add-cat');
const nameInput = document.getElementById('new-cat-name');
const errorBox = document.getElementById('new-cat-error');
const selectCats = document.getElementById('{{ form.categorias.auto_id }}');

if (addBtn && nameInput && selectCats) {
  addBtn.addEventListener('click', async () => {
    const nombre = (nameInput.value || '').trim();

    errorBox.classList.add('d-none');
    errorBox.textContent = '';

    if (!nombre) {
      errorBox.textContent = 'Ingresá un nombre.';
      errorBox.classList.remove('d-none');
      return;
    }

    addBtn.disabled = true;
    addBtn.textContent = 'Agregando…';

    try {
      const res = await fetch("{% url 'categoria_create_ajax' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: new URLSearchParams({ nombre })
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || 'Error al crear la categoría');
      }

      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Error al crear la categoría');

      // Agrego option y lo dejo seleccionado
      const opt = document.createElement('option');
      opt.value = data.id;
      opt.textContent = data.nombre;
      opt.selected = true;
      selectCats.appendChild(opt);

      // Mensaje de éxito del JSON (feedback inmediato)
      flash('success', data.message || `Categoría «${data.nombre}» creada.`);

      // limpiar input
      nameInput.value = '';
      nameInput.focus();

    } catch (err) {
      errorBox.textContent = err.message || 'Fallo al crear la categoría.';
      errorBox.classList.remove('d-none');
    } finally {
      addBtn.disabled = false;
      addBtn.textContent = '+ Agregar categoría';
    }
  });
}

(function () {
  const form = document.getElementById('form-libro');
  if (!form) return;
  form.addEventListener('submit', function (e) {
    // Si querés forzar envío siempre, descomentá:
    // e.stopPropagation();
    // this.submit();
  });
})();

(function () {
  const form = document.getElementById('form-libro');
  const btn = document.getElementById('btn-save');
  if (!form || !btn) return;

  // Aseguramos que el select tenga multiple (por si algún CSS/JS lo rompe)
  const selectCats = document.getElementById('{{ form.categorias.auto_id }}');
  if (selectCats && !selectCats.multiple) {
    selectCats.setAttribute('multiple', 'multiple');
  }

  btn.addEventListener('click', function () {
    // Si querés validar básico en el cliente, podrías chequear value/length acá.
    // Igual tenemos validación en el servidor con el ModelForm.

    // Forzamos envío REAL aunque algún script global haga preventDefault().
    form.submit(); // ¡saltea listeners de submit!
  });
})();

</script>
{% endblock %}
