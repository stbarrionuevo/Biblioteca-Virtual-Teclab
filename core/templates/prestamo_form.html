{% extends "base.html" %}
{% block title %}Cargar Préstamo{% endblock %}
{% block content %}
<h1 class="text-center">Cargar Préstamo</h1>
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}
<form class="card p-3 bg-white needs-validation" method="post" novalidate id="form-prestamo">
  {% csrf_token %}
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Nombre Completo del Alumno</label>
      <input class="form-control" name="nombre" required minlength="2" maxlength="200" placeholder="Ej: Juan Gomez"  value="{{ nombre|default:'' }}">
      <div class="invalid-feedback">Ingresá nombre y apellido (2–200 caracteres).</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">DNI</label>
      <input class="form-control" required name="dni" maxlength="8" placeholder="Ej: XX-XXX-XXX" value="{{ dni|default:'' }}" type="number" inputmode="numeric" >
      <div class="invalid-feedback">Ingresá un DNI válido.</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Libro seleccionado</label>
      <select class="form-select" name="libro" required>
        <option value="">Seleccioná…</option>
        {% for t in libros_opts %}
        <option value="{{ t }}" {% if libro == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
      <div class="form-text">Solo se listan libros disponibles.</div>
      <div class="invalid-feedback">Seleccioná un libro.</div>
    </div>
    <div class="col-md-6">
        <label for="fecha_vencimiento" class="form-label">Fecha de devolución</label>
    <input type="date"
           id="fecha_vencimiento"
           name="fecha_vencimiento"
           class="form-control"
           min="{{ hoy|date:'Y-m-d' }}"
           max="{{ hoy|add:'30 days'|date:'Y-m-d' }}"
           required>
           <div class="form-text">Debe ser día hábil (lun-vie), entre hoy y 30 días.</div>
      <div class="form-text">Una vez vencido su préstamo deberá devolver el libro en condiciones o será sujeto a la sanción/multa correspondiente.</div>
      <div class="invalid-feedback">Elegí una fecha válida de lunes a viernes.</div>
    </div>
  </div>
  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" type="submit" data-loading="Guardando...">Guardar </button>
    <a class="btn btn-outline-secondary" href="prestamos_list.html">Cancelar</a>
  </div>
</form>
<script>


(function () {
  const input = document.getElementById("fecha_vencimiento");
  if (!input) return;

  function isWeekend(yyyy_mm_dd) {

    const d = new Date(yyyy_mm_dd + "T12:00");
    const day = d.getDay(); 
    return day === 0 || day === 6;
  }

  function validate() {
    const val = input.value;
    if (!val) { input.setCustomValidity(""); return; }

    if (isWeekend(val)) {
    
      input.value = "";
      input.setCustomValidity("No se permiten sábados ni domingos.");
      input.reportValidity(); 
    } else {
      input.setCustomValidity("");
    }
  }

  input.addEventListener("change", validate);
  input.addEventListener("input", validate);
  validate();
})();
document.addEventListener("DOMContentLoaded", function(){
  const el = document.getElementById("fecha_vencimiento");
  if (!el || !window.flatpickr) return;

  flatpickr(el, {
    dateFormat: "Y-m-d",
    minDate: "{{ hoy|date:'Y-m-d' }}",
    maxDate: "{{ max_date|date:'Y-m-d' }}",
    disable: [
      function(date) {
      
        return (date.getDay() === 0 || date.getDay() === 6);
      }
    ],
  
    locale: { firstDayOfWeek: 1 }
  });
});

document.addEventListener("input", (e) => {
  const form = e.target.closest("#form-prestamo");
  if (form) form.classList.add("was-validated");
});
</script>
{% endblock %}